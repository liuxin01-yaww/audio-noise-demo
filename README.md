# WebRTC 音频通信演示程序

这是一个基于WebRTC技术的音频通信演示程序，支持两个Web端之间的实时音频通信以及音频录制和下载功能。

## 功能特性

- 🎤 **实时音频传输**: 支持两个Web端之间的实时音频通信
- 🎧 **音频录制**: 在拉流端录制接收到的音频
- 📥 **音频下载**: 录制完成后支持下载音频文件
- 🎨 **现代化UI**: 美观的用户界面设计
- 📱 **响应式设计**: 支持移动设备和桌面设备
- 🔄 **设备选择**: 支持选择不同的音频输入设备

## 技术栈

- **后端**: Node.js + Express + Socket.IO
- **前端**: HTML5 + CSS3 + JavaScript
- **核心技术**: WebRTC API + MediaRecorder API
- **信令**: Socket.IO 实现实时通信

## 安装和使用

### 1. 安装依赖

```bash
npm install
```

### 2. 启动服务器

#### 方式一：HTTPS服务器（推荐）
```bash
# 生成SSL证书并启动HTTPS服务器
npm run dev

# 或者分步执行：
npm run cert    # 生成SSL证书
npm start       # 启动服务器
```

#### 方式二：HTTP服务器
```bash
npm start
```

### 3. 访问应用

#### HTTPS访问（推荐）

**localhost访问：**
- 首页: https://localhost:3000
- 推流端: https://localhost:3000/sender
- 拉流端: https://localhost:3000/receiver

**IP地址访问：**
服务器启动后会显示所有可访问的IP地址，例如：
- 首页: https://192.168.1.100:3000
- 推流端: https://192.168.1.100:3000/sender
- 拉流端: https://192.168.1.100:3000/receiver

⚠️ **首次访问时，浏览器会显示安全警告（自签名证书），点击"高级"并选择"继续访问"即可。**

#### HTTP访问
如果没有生成SSL证书，服务器将使用HTTP：
- 首页: http://localhost:3000 或 http://[IP地址]:3000
- 推流端: http://localhost:3000/sender 或 http://[IP地址]:3000/sender
- 拉流端: http://localhost:3000/receiver 或 http://[IP地址]:3000/receiver

### 4. IP访问配置

#### 网络接口绑定
服务器默认监听所有网络接口（0.0.0.0），支持：
- 本机访问（localhost、127.0.0.1）
- 局域网访问（192.168.x.x、10.x.x.x等）
- 外网访问（如果有公网IP）

#### SSL证书支持
生成的SSL证书自动包含：
- localhost域名
- 本机所有IP地址
- 127.0.0.1回环地址

#### 防火墙设置
确保防火墙允许以下端口：
- 3000端口（主服务器）
- 3001端口（HTTP重定向）

### 5. HTTPS重定向

启用HTTPS后，系统会自动创建HTTP重定向服务器（端口3001），将HTTP请求重定向到HTTPS。

## 使用说明

### 基本使用流程

#### 本机测试
1. **打开两个浏览器窗口**
2. **分别访问推流端和拉流端**
3. **在推流端**:
   - 点击"开始推流"按钮
   - 允许浏览器访问麦克风
   - 等待连接建立
4. **在拉流端**:
   - 点击"开始拉流"按钮
   - 等待连接建立
   - 连接成功后可以听到推流端的音频

#### 跨设备测试
1. **确保设备在同一局域网内**
2. **在设备A上启动推流端**：
   - 访问 `https://[服务器IP]:3000/sender`
   - 点击"开始推流"
3. **在设备B上启动拉流端**：
   - 访问 `https://[服务器IP]:3000/receiver`
   - 点击"开始拉流"
4. **建立连接后即可进行跨设备音频通信**

### 音频录制

1. **建立连接后，在拉流端**:
   - 点击"开始录制"按钮开始录制
   - 录制过程中会显示录制指示器
   - 点击"停止录制"结束录制
2. **录制完成后**:
   - 可以点击"播放录制"预览音频
   - 点击"下载录制的音频"下载文件

### 高级功能

- **音频设备选择**: 在推流端可以选择不同的音频输入设备
- **音量控制**: 在拉流端可以调节音量
- **静音功能**: 推流端支持静音/取消静音
- **连接状态**: 实时显示连接状态信息

## 项目结构

```
audio-noise/
├── package.json                 # 项目配置
├── signaling-server.js          # 信令服务器
├── index.html                   # 首页
├── sender.html                  # 推流端页面
├── receiver.html                # 拉流端页面
├── public/                      # 静态文件目录
│   ├── styles.css              # 样式文件
│   ├── sender.js               # 推流端逻辑
│   └── receiver.js             # 拉流端逻辑
└── README.md                   # 说明文档
```

## 重要说明

1. **HTTPS要求**: 
   - WebRTC在生产环境中需要HTTPS协议
   - 现代浏览器在非localhost环境下要求HTTPS才能访问音频设备
   - 推荐使用 `npm run dev` 启动HTTPS服务器

2. **SSL证书**:
   - 开发环境：使用 `npm run cert` 生成自签名证书
   - 生产环境：使用正式的SSL证书（Let's Encrypt等）
   - 浏览器安全警告：自签名证书会触发警告，点击"高级"继续访问

3. **浏览器支持**: 现代浏览器都支持WebRTC，建议使用Chrome或Firefox

4. **权限要求**: 推流端需要麦克风权限

5. **网络环境**: 建议在同一网络环境下测试，跨网络可能需要TURN服务器

6. **音频格式**: 录制的音频格式为WebM，大部分浏览器都支持播放

## 故障排除

### 常见问题

1. **无法获取麦克风权限**
   - 确保浏览器允许访问麦克风
   - 检查操作系统的权限设置

2. **连接失败**
   - 检查网络连接
   - 确保防火墙没有阻止连接
   - 尝试刷新页面重新连接

3. **音频无声音**
   - 检查音量设置
   - 确保推流端没有静音
   - 检查音频设备是否正常工作

4. **录制失败**
   - 确保已经建立连接
   - 检查浏览器是否支持MediaRecorder API
   - 尝试使用不同的浏览器

5. **SSL证书问题**
   - 证书生成失败：确保已安装OpenSSL
   - 浏览器安全警告：点击"高级" → "继续访问"
   - 证书过期：重新运行 `npm run cert` 生成新证书

6. **HTTPS访问问题**
   - 无法访问HTTPS：检查SSL证书是否正确生成
   - 重定向失败：确保端口3001未被占用
   - 混合内容错误：确保所有资源都通过HTTPS加载

7. **IP访问问题**
   - 无法通过IP访问：检查防火墙设置，确保端口3000、3001开放
   - 局域网设备无法访问：确保设备在同一网络内
   - SSL证书错误：重新生成证书 `npm run cert`
   - 跨设备连接失败：检查网络连接和WebRTC配置

## 开发和扩展

### 添加新功能

- **视频通信**: 可以扩展支持视频传输
- **文件传输**: 可以添加文件传输功能
- **多人会议**: 可以扩展为多人音视频会议系统
- **录制格式**: 可以支持更多音频格式的录制

### 生产部署

1. **使用HTTPS**: 配置SSL证书
2. **TURN服务器**: 配置TURN服务器支持NAT穿透
3. **性能优化**: 添加负载均衡和缓存
4. **监控日志**: 添加监控和日志系统

## 许可证

ISC License

## 联系方式

如有问题或建议，请通过项目Issues页面反馈。 